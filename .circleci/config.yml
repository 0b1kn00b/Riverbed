version: 2
jobs:
    interpret_test:
        docker:
            - image: haxe:4.0.5
        steps:
            - checkout
            - run:
                name: Interpret Tests
                command: haxelib install uTest && haxelib list && haxe interpret-tests.hxml
    compile_tests:
        docker:
            - image: haxe:4.0.5
        steps:
            - checkout
            - run:
                name: Install Dependencies
                command: haxelib install uTest
            - run:
                name: Compile Tests
                command: haxe compile-tests.hxml
            - run:
                name: Prepare Workspace
                command: |
                    mkdir workspace/
                    cp -r build/ workspace/build/
            - persist_to_workspace:
                root: workspace
                paths:
                    - build
    neko_test:
        docker:
            - image: haxe:4.0.5
        steps:
            - attach_workspace:
                at: workspace
            - run:
                name: Extract Workspace
                command: |
                    cp -r workspace/build/ build/
            - run:
                name: Run Neko Tests
                command: |
                    neko build/test/neko-test.n
    python_test:
        docker:
            - image: python:3.6.7
        steps:
            - attach_workspace:
                at: workspace
            - run:
                name: Extract Workspace
                command: |
                    cp -r workspace/build/ build/
            - run:
                name: Run Neko Tests
                command: |
                    python build/test/python-test.py
# TODO refactor out similar parts of this yml with yaml anchors/aliases (https://circleci.com/blog/circleci-hacks-reuse-yaml-in-your-circleci-config-with-yaml/)
workflows:
    version: 2
    test:
        jobs:
            - interpret_test
            - compile_tests:
                requires:
                    - interpret_test
            - neko_test:
                requires:
                    - compile_tests
            - python_test:
                requires:
                    - compile_tests
